# Send prefix
set-option -g prefix C-q
unbind-key C-q
bind-key C-q send-prefix

# 更改分割水平和垂直窗口按键
unbind '"'
bind-key v split-window -v
unbind %
bind-key h split-window -h

# 清理屏幕和缓存，只保留一个命令提示符
# 如果在复制模式中先退出，然后清理
bind-key l if-shell -F '#{pane_in_mode}' 'send-keys -X cancel' '' \; \
          send-keys C-l \; send-keys -R \; clear-history \; send-keys Enter


# 打开鼠标控制
set -g mouse on

# 设置窗口和分区编号从1开始
set -g base-index 1          # 窗口编号从1开始
set -g pane-base-index 1     # 分区编号从1开始

# ============================================
# tmux 3.6 新特性配置
# ============================================

# 滚动条支持 - 在面板右侧显示滚动条
set -g pane-scrollbars on
set -g pane-scrollbars-position right
set -g pane-scrollbars-style "bg=#444444,fg=#667eea,width=1,pad=0"

# 输入缓冲区大小 - 增加输入缓冲区以处理更多输入
set -g input-buffer-size 1048576  # 1MB

# 初始重复时间 - 第一次按键重复延迟较长，后续较快
set -g initial-repeat-time 500
set -g repeat-time 100

# 面板边框使用空格 - 更清晰的边框显示
set -g pane-border-lines spaces

# 代码点宽度配置 - 确保 Unicode 字符正确显示
set -g codepoint-widths "U+1F600-U+1F64F=2,U+1F300-U+1F5FF=2,U+1F680-U+1F6FF=2,U+1F1E6-U+1F1FF=2"

# 复制模式样式配置 (tmux 3.6)
set -g copy-mode-position-style "bg=#ed8936,fg=#ffffff,bold"
set -g copy-mode-selection-style "bg=#38a169,fg=#ffffff"

# 命令提示符光标样式 (tmux 3.6)
set -g prompt-cursor-colour "#48bb78"
set -g prompt-cursor-style "blinking-block"

# 主题检测支持 (mode 2031) - 自动检测暗色/亮色主题
# tmux 会根据终端背景色自动调整主题

# 状态栏
set -g status-justify left # 状态栏列表左对齐
setw -g monitor-activity on # 非当前窗口有内容更新时在状态栏通知
set -g status-interval 1 # 状态栏刷新时间

# 状态栏颜色配置
set -g status-style "bg=#2d3748,fg=#e2e8f0"                    # 状态栏背景和前景色
set -g status-left-style "bg=#4a5568,fg=#ffffff"               # 左侧状态栏样式
set -g status-right-style "bg=#4a5568,fg=#ffffff"   

# 颜色亮度调整说明：
# 原色 -> 调亮 -> 调暗
# #667eea -> #8fa2ff -> #4a5dc7 (蓝色系)
# #48bb78 -> #6dd89d -> #38a169 (绿色系)  
# #ed8936 -> #ffa154 -> #dd6b20 (橙色系)

# 设置全部面板背景色
set -g window-style 'bg=#2a2a2a'
set -g window-active-style 'bg=#1c1c1c'

# 边框也设置柔和色调
set -g pane-border-style 'fg=#444444'                # 柔和边框
set -g pane-active-border-style 'fg=#666666'  
# 设置状态栏长度
set -g status-left-length 250
set -g status-right-length 50

# 动态获取tmux配置文件的真实路径（支持软链接）
# 方法：使用run-shell同步执行（不加-b参数），确保在status-format使用前环境变量已设置
# run-shell 不加 -b 参数时会同步执行（等待命令完成），这样可以确保环境变量在后续配置使用前已经设置好
run-shell 'CONFIG_REALFILE=$(readlink -f ~/.tmux.conf 2>/dev/null || echo ~/.tmux.conf); tmux set-environment -g CONFIG_REALFILE "$CONFIG_REALFILE"'
run-shell 'CONFIG_DIR=$(dirname $(readlink -f ~/.tmux.conf 2>/dev/null || echo ~/.tmux.conf)); tmux set-environment -g CONFIG_DIR "$CONFIG_DIR"'

# 状态栏theme (增强版，使用 tmux 3.6 新特性)
set -g status-format[0] "\
#[bg=#667eea,fg=#ffffff] Sess: #S \
#[bg=#3b5998,fg=#667eea]\
#[bg=#48bb78,fg=#3b5998]\
#[bg=#48bb78,fg=#ffffff] Wins: \
#{W:#{?#{==:#{window_index},#{active_window_index}},#{E:window-status-current-format},#{E:window-status-format}}}\
#[bg=#48bb78,fg=#48bb78]\
#[bg=#ed8936,fg=#48bb78]\
#[bg=#ed8936,fg=#ffffff] Pane: #[fg=#ffd700]#P/#{window_panes} (#{pane_current_command}) \
#[bg=#dd6b20,fg=#ed8936]\
#[bg=#2d3748,fg=#dd6b20]\
#[align=right]\
#[bg=#2d3748,fg=#38a169]\
#[bg=#38a169,fg=#ffffff] #(#{CONFIG_DIR}/battery.sh) \
#[bg=#38a169,fg=#60a5fa]\
#[bg=#60a5fa,fg=#ffffff] #(#{CONFIG_DIR}/system_monitor.sh) \
#[bg=#60a5fa,fg=#9f7aea]\
#[bg=#9f7aea,fg=#ffffff] %Y-%m-%d %Z \
#[bg=#9f7aea,fg=#6b46c1]\
#[bg=#6b46c1,fg=#ffffff] %H:%M:%S \
#[bg=#6b46c1,fg=#6b46c1]\
"

# 禁用默认的left和right
set -g status-left ""
set -g status-right ""

# Window列表样式
set -g window-status-format "\
#[bg=#48bb78,fg=#ffffff] #I\
#[bg=#48bb78,fg=#ffffff] #W \
#[bg=#48bb78,fg=#48bb78]\
"
# 当前window 样式
set -g window-status-current-format "\
#[bg=#38a169,fg=#ffffff,bold] #I\
#[bg=#38a169,fg=#1a202c,bold] #W \
#[bg=#48bb78,fg=#38a169]\
"

# window 列表间隔符
set -g window-status-separator ""

# 设置复制模式 vi or emacs
setw -g mode-keys vi

# 展示颜色 
set -g default-terminal "screen-256color" 
set -ga terminal-overrides ",*256col*:Tc"

# 重新加载配置
bind r source-file ~/.tmux.conf \; display-message "Config reloaded..."

# ============================================
# FZF 集成 - 弹出窗口搜索功能
# ============================================

# 检测 fzf 是否安装，如果安装则启用文件和目录搜索功能 (Ctrl+Q + f)
if-shell "command -v fzf >/dev/null 2>&1" \
  "bind f if-shell -F '#{pane_in_mode}' 'send-keys -X cancel' '' \\; display-popup -E -w 80% -h 80% -d '#{pane_current_path}' 'find . -not -path \"*/\\.git/*\" -not -path \"*/node_modules/*\" 2>/dev/null | fzf --reverse --header=\"[j/k:Up/Down h/l:Preview Scroll /:Search Enter:Select]\" --bind \"j:down,k:up,h:preview-up,l:preview-down\" --bind \"/:clear-query\" --preview \"if [ -d {} ]; then ls -lah {}; else bat --color=always --style=numbers {} 2>/dev/null || cat {}; fi\" --preview-window=right:60% | xargs -I {} sh -c \"if [ -d \\\"{}\\\" ]; then tmux send-keys \\\"cd \\\\\\\"{}\\\\\\\"\\\" Enter; else tmux send-keys \\\"nvim \\\\\\\"{}\\\\\\\"\\\" Enter; fi\"'"

# 设置窗口标题
set -g set-titles on
set -g set-titles-string "#S:#I.#P #W"

# 插件列表 
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-yank'

# tmux-yank插件配置
set -g @yank_action 'copy-pipe-no-clear'
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
# 禁用 tmux-yank 的默认按键绑定，使用我们自定义的
set -g @override_copy_command 'wl-copy'
# set -g @plugin 'catppuccin/tmux#v2.1.2' # See Tags · catppuccin/tmux for additional tags
# set -g @catppuccin_flavor 'mocha'
# set -g @catppuccin_window_status_style "rounded"


# 初始化插件管理器
run -b '~/.tmux/plugins/tpm/tpm'

# vi模式复制按键绑定（放在插件加载后，避免被插件覆盖）
# 先取消可能存在的默认绑定，确保使用我们的自定义绑定
unbind-key -T copy-mode-vi v
unbind-key -T copy-mode-vi V

# 重新绑定按键
bind -T copy-mode-vi v send-keys -X begin-selection              # v开始选择
bind -T copy-mode-vi V send-keys -X select-line                  # V选择整行
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle           # Ctrl+v切换矩形选择
bind -T copy-mode-vi y send-keys -X copy-pipe "wl-copy" \; send-keys -X clear-selection  # y复制到系统剪贴板，清除高亮，不退出
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "wl-copy"  # Enter复制并退出
bind -T copy-mode-vi Escape send-keys -X cancel                  # Esc退出复制模式

# ============================================
# tmux 3.6 新特性增强功能
# ============================================

# 更好的复制模式导航 (支持不区分大小写搜索)
bind -T copy-mode-vi '/' command-prompt -p "Search:" "send-keys -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi '?' command-prompt -p "Search backward:" "send-keys -X search-backward-incremental \"%%%\""

# 居中光标在复制模式中 (tmux 3.6)
bind -T copy-mode-vi 'C-l' send-keys -X centre-cursor

# 使用 capture-pane 的 -M 标志 (tmux 3.6) - 在复制模式中捕获
bind -T copy-mode-vi 'M' send-keys -X capture-pane -M \; send-keys -X page-up

# 窗口树排序 (tmux 3.6) - 按名称排序窗口
bind 'w' choose-tree -s -O name

# 会话排序 (tmux 3.6)
bind 's' choose-session -O name

